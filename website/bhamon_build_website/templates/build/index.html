{% extends 'layout.html' %}
{% import 'task/macros.html' as task_macros %}

{% block content %}
<h1>Build {{ build['identifier'] }}</h1>

<section>
	<div class="link-group">
		<a href="{{ url_for('download_build_archive', build_identifier = build['identifier']) }}">Download as archive</a>
	</div>
</section>

<section>
	<h2>Status</h2>
	<div class=status-grid>
		<div class="status-group">
			<div class="status-indicator {{ build['status'] }}"></div>
			<div class="status-text">{{ build['status'] }}</div>
		</div>
		{% if authorize_view("build-actions") %}
		<form method="post">
			{% if build['status'] == 'running' %}
			<button formaction="{{ url_for('abort_build', build_identifier = build['identifier']) }}">Abort</button>
			{% else %}
			<button formaction="{{ url_for('abort_build', build_identifier = build['identifier']) }}" disabled>Abort</button>
			{% endif %}
		</form>
		{% endif %}
	</div>
	<ul>
		<li>Job: <a href="{{ url_for('job_index', job_identifier = build['job']) }}" style="display: inline">{{ build['job'] }}</a></li>
		<li>Worker: {% if build['worker'] %}<a href="{{ url_for('worker_index', worker_identifier = build['worker']) }}" style="display: inline">{{ build['worker'] }}</a>{% endif %}</li>
		<li>Creation date: {{ build['creation_date'] }}</li>
		<li>Update date: {{ build['update_date'] }}</li>
		<li>Start date: {{ build['start_date'] }}</li>
		<li>Completion date: {{ build['completion_date'] }}</li>
	</ul>
</section>

<section>
	<h2>Parameters</h2>
	<ul>
		{% for key, value in build['parameters'].items() %}
		<li>{{ key }}: {{ value }}</li>
		{% endfor %}
	</ul>
</section>

<section>
	<h2>Steps</h2>
	<table>
		<thead>
			<tr>
				<th>Index</th>
				<th>Name</th>
				<th>Status</th>
				<th>Log</th>
			</tr>
		</thead>
		<tbody>
			{% for step in build_steps %}
			<tr>
				<td>{{ step['index'] }}</td>
				<td>{{ step['name'] }}</td>
				<td>
					<div class="status-group">
						<div class="status-indicator {{ step['status'] }}"></div>
						<div class="status-text">{{ step['status'] }}</div>
					</div>
				</td>
				<td><a href="{{ url_for('build_step_log', build_identifier = build['identifier'], step_index = step['index']) }}">Log</a></td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</section>

<section>
	<h2>Results</h2>
	<ul>
		{% if build_results.get('revision_control', {}) %}
		<li>
			<p>Revision Control</p>
			<ul>
				<li>
					<span>
						<a href="{{ build_results['revision_control']['url'] }}" style="display: inline">
							{{ build_results['revision_control']['revision'] }}
						</a>
					</span>
					<span>
						({{ build_results['revision_control']['date'] }})
					</span>
				</li>
			</ul>
		</li>
		{% endif %}
		{% if build_results.get('child_builds', []) %}
		<li>
			<p>Child Builds</p>
			<ul>
				{% for child_build in build_results['child_builds'] %}
				<li>
					<a href="{{ url_for('build_index', build_identifier = child_build['build_identifier']) }}">
						{{ child_build['job_identifier'] }} {{ child_build['build_identifier'] }}
					</a>
				</li>
				{% endfor %}
			</ul>
		</li>
		{% endif %}
		{% if build_results.get('tests', []) %}
		<li>
			<p>Tests</p>
			<ul>
				{% for test_run in build_results['tests'] %}
				<li>
					<span>
						{{ test_run['run_type'] }} {{ 'succeeded' if test_run['success'] else 'failed ' }}
					</span>
					{% if test_run.get('summary_text', none) %}
					<span>
						({{ test_run['summary_text'] }})
					</span>
					{% endif %}
				</li>
				{% endfor %}
			</ul>
		</li>
		{% endif %}
		{% if build_results.get('artifacts', []) %}
		<li>
			<p>Artifacts</p>
			<ul>
				{% for artifact in build_results['artifacts'] %}
				<li>
					<a href="{{ artifact['url'] }}">
						{{ artifact['name'] }}
					</a>
				</li>
				{% endfor %}
			</ul>
		</li>
		{% endif %}
		{% if build_results.get('distributions', []) %}
		<li>
			<p>Distributions</p>
			<ul>
				{% for distribution in build_results['distributions'] %}
				<li>
					<a href="{{ distribution['url'] }}">
						{{ distribution['name'] }} {{ distribution['version'] }}
					</a>
				</li>
				{% endfor %}
			</ul>
		</li>
		{% endif %}
	</ul>
</section>

<section>
	<h2><a href="{{ url_for('task_collection_index', build = build['identifier']) }}" title="View all tasks">Tasks</a></h2>
	{{ task_macros.task_table(build_tasks) }}
</section>
{% endblock %}
